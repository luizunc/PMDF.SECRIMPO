<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termo de Apreensão - Prévia</title>
    <link rel="stylesheet" href="../styles/custom-alert.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #pdf-container {
            width: 100%;
            height: 100vh;
            margin-top: 60px;
        }

        #pdf-container embed,
        #pdf-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div id="pdf-container"></div>
    <script>
        // Carregar custom-alert primeiro
        const customAlertScript = document.createElement('script');
        customAlertScript.src = '../scripts/custom-alert.js';
        document.head.appendChild(customAlertScript);
        
        // Aguardar carregamento do custom-alert antes de continuar
        customAlertScript.onload = () => {
            initPDFViewer();
        };
        
        function initPDFViewer() {
        const { ipcRenderer } = require('electron');
        
        let pdfPath = null;
        let occurrenceData = null;
        
        // Obter caminho do PDF e dados da ocorrência via IPC
        ipcRenderer.once('pdf-data', (event, data) => {
            pdfPath = data.pdfPath;
            occurrenceData = data.occurrenceData;
            
            // Carregar PDF
            const container = document.getElementById('pdf-container');
            const embed = document.createElement('embed');
            embed.src = `file://${pdfPath.replace(/\\/g, '/')}`;
            embed.type = 'application/pdf';
            container.appendChild(embed);
        });

        // Criar toolbar com botões
        const toolbar = document.createElement('div');
        toolbar.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #071d49 0%, #0a2d6e 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10000; font-family: system-ui, -apple-system, sans-serif;';
        
        const title = document.createElement('div');
        title.textContent = 'Termo de Apreensão';
        title.style.cssText = 'font-size: 16px; font-weight: normal;';
        
        const actions = document.createElement('div');
        actions.style.cssText = 'display: flex; gap: 10px;';

        const btnSavePNG = document.createElement('button');
        btnSavePNG.textContent = 'Salvar como PNG';
        btnSavePNG.style.cssText = 'padding: 10px 20px; background: #fac709; color: #333; border: none; border-radius: 8px; font-size: 14px; font-weight: normal; cursor: pointer; font-family: inherit;';
        btnSavePNG.onclick = () => {
            if (occurrenceData) {
                // Serializar dados para evitar erro de clonagem
                try {
                    const serializedData = JSON.parse(JSON.stringify(occurrenceData));
                    ipcRenderer.invoke('save-termo-as-png', serializedData).then(result => {
                    if (result && result.success) {
                        if (window.customAlert) {
                            window.customAlert.success('PNG salvo com sucesso!', 'Sucesso');
                        } else {
                            alert('PNG salvo com sucesso!');
                        }
                    } else if (result && !result.canceled) {
                        if (window.customAlert) {
                            window.customAlert.error(result.message || 'Erro desconhecido ao salvar PNG', 'Erro');
                        } else {
                            alert('Erro ao salvar PNG: ' + (result.message || 'Erro desconhecido'));
                        }
                    }
                }).catch(err => {
                    console.error('Erro ao salvar PNG:', err);
                    if (window.customAlert) {
                        window.customAlert.error('Erro ao salvar PNG: ' + (err.message || 'Erro desconhecido'), 'Erro');
                    } else {
                        alert('Erro ao salvar PNG: ' + err.message);
                    }
                });
                } catch (serializeError) {
                    console.error('Erro ao serializar dados:', serializeError);
                    if (window.customAlert) {
                        window.customAlert.error('Erro ao preparar dados para salvamento', 'Erro');
                    } else {
                        alert('Erro ao preparar dados para salvamento');
                    }
                }
            } else {
                if (window.customAlert) {
                    window.customAlert.error('Dados da ocorrência não disponíveis', 'Erro');
                } else {
                    alert('Erro: Dados da ocorrência não disponíveis');
                }
            }
        };
        
        const btnPrint = document.createElement('button');
        btnPrint.textContent = 'Imprimir';
        btnPrint.style.cssText = 'padding: 10px 20px; background: linear-gradient(135deg, #279b4d 0%, #1f8040 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: normal; cursor: pointer; font-family: inherit;';
        btnPrint.onclick = () => window.print();
        
        const btnClose = document.createElement('button');
        btnClose.textContent = 'Fechar';
        btnClose.style.cssText = 'padding: 10px 20px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 14px; font-weight: normal; cursor: pointer; font-family: inherit;';
        btnClose.onclick = () => window.close();
        
        actions.appendChild(btnSavePNG);
        actions.appendChild(btnPrint);
        actions.appendChild(btnClose);
        toolbar.appendChild(title);
        toolbar.appendChild(actions);
        document.body.insertBefore(toolbar, document.body.firstChild);
        }
    </script>
</body>
</html>

